\documentclass[10pt,titlepage]{article}
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
\usepackage{amsmath,amsfonts,amsthm}
\usepackage{spverbatim}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{pgfplots}
\usepackage[letterpaper, margin=2in]{geometry}
\usepackage{titlesec}
\usepackage{fancyhdr}
\usetikzlibrary{trees}
\usepackage{hyperref}
\usepackage{enumitem}

\lstdefinestyle{mystyle}{
  keywordstyle=\color{blue},
  commentstyle=\color{red},
  stringstyle=\color{violet},
  basicstyle=\fontsize{12}{12},
  columns=fullflexible,
  breaklines=true
}

\titleformat{\section}
  {\normalfont\Large\bfseries}{\thesection}{1em}{}[{\titlerule[0.8pt]}]

\lstset{style=mystyle}

\title{Spark Setup Documentation}
\author{Abraham Sharum, Isaac Tunchez, Andrew Appleyard\\ Class: CS 30003 - Distributed Systems}

\begin{document}
\pagestyle{fancy}
\fancyhead{}
\fancyhead[LE,LO]{\textbf{CCS 30003 -- Distributed Systems}}
\fancyhead[RO,RE]{\textbf{Spark Anayltics Setup}}
\fancyfoot{}
\fancyfoot[CE,CO]{\textbf{\thepage}}
\maketitle

\section*{Demonstration Guide}

\subsection*{Installation Steps}
\begin{enumerate}[leftmargin=*]
  \item Install Docker and Docker Compose.
  \item Clone the repository.
  \item Create a root \texttt{.env} with at least:
  \begin{itemize}[leftmargin=*]
    \item \texttt{FINNHUB\_API\_KEY=}
    \item \texttt{INFLUXDB\_TOKEN=}
    \item \texttt{INFLUXDB\_USERNAME=}
    \item \texttt{INFLUXDB\_PASSWORD=}
    \item \texttt{INFLUXDB\_ORG=}
    \item \texttt{INFLUXDB\_BUCKET=}
    \item \texttt{GRAFANA\_USER=}
    \item \texttt{GRAFANA\_PASSWORD=}
  \end{itemize}
  \item Ensure these ports are free:
  \begin{itemize}[leftmargin=*]
    \item 3000, 4000, 7077, 8001, 8080, 8081
    \item 8082, 8086, 8800, 35000, 35001
  \end{itemize}
\end{enumerate}

\subsection*{Run the Containers (Exact Commands)}
\begin{itemize}[leftmargin=*]
  \item Build and start: \texttt{docker compose up --build}
  \item Stop: \texttt{docker compose down}
  \item Rebuild a single service (example backend): \texttt{docker compose build backend}
  \item Spark services: master + two workers come up via compose; workers are limited to \texttt{SPARK\_WORKER\_CORES=2} and \texttt{SPARK\_WORKER\_MEMORY=2g}.
  \item Docker Swarm (optional deployment):
  \begin{itemize}[leftmargin=*]
    \item Init swarm: \texttt{sudo docker swarm init --advertise-addr <your-ip>}
    \item Check status: \texttt{sudo docker info | grep -A3 "Swarm"}
    \item List nodes: \texttt{sudo docker node ls}
    \item Deploy stack: \texttt{sudo docker stack deploy -c docker-stack.prod.yaml distributed}
    \item List services: \texttt{sudo docker stack services distributed}
    \item Same as above: \texttt{sudo docker service ls}
    \item Inspect service: \texttt{sudo docker service ps <service\_name>} and logs: \texttt{sudo docker service logs -f <service\_name>}
    \item Remove stack: \texttt{sudo docker stack rm distributed}
    \item Leave swarm: \texttt{sudo docker swarm leave --force} (re-run init after leaving)
  \end{itemize}
\end{itemize}

\subsection*{Run the CRUD Application}
\begin{itemize}[leftmargin=*]
  \item Backend FastAPI: \texttt{http://localhost:4000} (Swagger UI at \texttt{/docs}).
  \item Frontend dashboard: \texttt{http://localhost:8800} (renders Grafana embed).
  \item Key endpoints:
  \begin{itemize}[leftmargin=*]
    \item \texttt{GET /portfolio} --- list all trades.
    \item \texttt{GET /balance} --- show simulated cash balance.
    \item \texttt{POST /trades} --- create; debits balance (e.g. \verb|{"symbol":"AAPL","shares":5,"buy_price":180}|).
    \item \texttt{PUT /trades/\{symbol\}} --- update price/shares; adjusts balance (e.g. \verb|{"new_price":185,"delta_shares":1,"current_price":190}|).
    \item \texttt{DELETE /trades/\{symbol\}} --- delete/sell; optional body \verb|{"sale_price":190}| to compute net gain and credit balance.
    \item \texttt{GET /cache} --- inspect in-memory price cache (refreshed every 5s for tracked symbols).
    \item \texttt{GET /quote/\{symbol\}} --- fetch latest quote via finnhub client; 502 if upstream fails.
    \item Price polling (optional): polls \texttt{PRICE\_SYMBOLS} every \texttt{PRICE\_POLL\_INTERVAL} seconds and writes to Influx \texttt{prices} when \texttt{INFLUXDB\_TOKEN} is set.
  \end{itemize}
  \item Finnhub quote API: \texttt{http://localhost:8001/quote/\{symbol\}} (uses \texttt{FINNHUB\_API\_KEY}).
  \item Grafana (optional dashboards): \texttt{http://localhost:3000}.
\end{itemize}

\subsection*{Reproduce the Custom Example}
\begin{enumerate}[leftmargin=*]
  \item Start services: \texttt{docker compose up --build}.
  \item Create a trade:
\begin{verbatim}
curl -X POST http://localhost:4000/trades \
  -H "Content-Type: application/json" \
  -d '{"symbol":"AAPL","shares":5,"buy_price":180}'
\end{verbatim}
  \item Update it:
\begin{verbatim}
curl -X PUT http://localhost:4000/trades/AAPL \
  -H "Content-Type: application/json" \
  -d '{"new_price":185}'
\end{verbatim}
  \item Delete it:
\begin{verbatim}
curl -X DELETE http://localhost:4000/trades/AAPL
\end{verbatim}
  \item Verify via \texttt{GET /portfolio} or refresh the frontend dashboard.
\end{enumerate}

\end{document}
